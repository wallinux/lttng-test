#!/bin/sh
set +x

#local target
SERVER_IP=localhost
TARGET_IP=localhost
TARGET_CMD=

if [ $# = 1 ] && [ $1 = "remote" ]; then
    #remote target
    TARGET_IP=135.15.35.94
    SERVER_IP=135.15.35.1
    USER=root
    TARGET_CMD="ssh $USER@$TARGET_IP"
fi 

SESSION=livetest
APP=./tracetest

DEBUG=-d
VERBOSE=-v

if [ $# -gt 0 ]; then
    NO_OF_THREADS=$1 
else    
    NO_OF_THREADS=3
fi

if [ $# -gt 1 ]; then 
    LOOPS=$2 
else    
    LOOPS=3
fi

MINLOOP=1000
MAXLOOP=$(($MINLOOP+$LOOPS))

prepare_target () {
    if [ $TARGET_IP != localhost ]; then
	echo Copy $APP to $USER@$TARGET_IP
	scp $APP $USER@$TARGET_IP:
    fi
    TARGET_NAME=$(echo $($TARGET_CMD hostname))
    ulimit -c unlimited
}

target_start_stop () {
    echo $1
    $TARGET_CMD lttng create $SESSION -U net://$SERVER_IP --live 1000000
    $TARGET_CMD lttng enable-event -a -u

#    babeltrace -v -d -i lttng-live net://localhost/host/$TARGET_NAME/$SESSION &> babeltrace.log
    babeltrace -i lttng-live net://localhost/host/$TARGET_NAME/$SESSION &
    babeltrace_pid=$!
    sleep 1

    #1
    $TARGET_CMD lttng start
    $TARGET_CMD ./tracetest $1 $NO_OF_THREADS
    sleep 1
    $TARGET_CMD lttng stop
    $TARGET_CMD lttng destroy $SESSION

    echo AAAAAAAAAAAAAAAAAAAAAAA
    ps -l | grep babeltrace

    #2
    $TARGET_CMD lttng create $SESSION -U net://$TARGET_IP --live 1000000
    $TARGET_CMD lttng enable-event -a -u
    $TARGET_CMD lttng start
    $TARGET_CMD ./tracetest $1 $NO_OF_THREADS
    sleep 1
    $TARGET_CMD lttng stop
    $TARGET_CMD lttng destroy $SESSION

    echo BBBBBBBBBBBBBBBBBBBBBBB
    ps -l | grep babeltrace

    sleep 1
    echo CCCCCCCCCCCCCCCCCCCCCCC
    ps -l | grep babeltrace


    #kill $babeltrace_pid
}


############################
prepare_target

echo ----------------------
echo LTTNG VERSIONS:
$TARGET_CMD lttng -V
babeltrace -h | head -1
echo ----------------------

# start relay daemon
lttng-relayd -L net://localhost:5344 &
lttng_relayd_pid=$!

for i in $(seq $MINLOOP $MAXLOOP); do
    target_start_stop $i
    if [ -e core ]; then
        echo core dumped!!
	ps -l
	break
    fi
done

kill $lttng_relayd_pid
sleep 1
ps -l
