From 55cce8710a142c03e1f1b96ad33d8fdd12d7bff6 Mon Sep 17 00:00:00 2001
Message-Id: <55cce8710a142c03e1f1b96ad33d8fdd12d7bff6.1476521217.git.anders.wallin@windriver.com>
From: Anders Wallin <anders.wallin@windriver.com>
Date: Wed, 12 Oct 2016 16:35:54 +0200
Subject: [PATCH 1/1] Using cat instead of man to show help text

Requires precompiled help files

Signed-off-by: Anders Wallin <anders.wallin@windriver.com>
---
 src/common/defaults.h |  5 ++++-
 src/common/utils.c    | 38 +++++++++++++++++++++++++++++---------
 2 files changed, 33 insertions(+), 10 deletions(-)

diff --git a/src/common/defaults.h b/src/common/defaults.h
index 59fe8ec..47bf0db 100644
--- a/src/common/defaults.h
+++ b/src/common/defaults.h
@@ -39,7 +39,10 @@
 #define DEFAULT_MAN_BIN_PATH_ENV                "LTTNG_MAN_BIN_PATH"
 
 /* Default man pager binary path. */
-#define DEFAULT_MAN_BIN_PATH                    "/usr/bin/man"
+#define DEFAULT_MAN_BIN_PATH                    "/bin/zcat"
+
+/* Environment variable to set man pager binary path. */
+#define DEFAULT_MAN_PATH_ENV                    "LTTNG_MAN_PATH"
 
 /* Default trace output directory name */
 #define DEFAULT_TRACE_DIR_NAME                  "lttng-traces"
diff --git a/src/common/utils.c b/src/common/utils.c
index 16d2f81..e2c106b 100644
--- a/src/common/utils.c
+++ b/src/common/utils.c
@@ -1361,25 +1361,45 @@ static const char *get_man_bin_path(void)
 	return DEFAULT_MAN_BIN_PATH;
 }
 
+static const char *get_man_path(void)
+{
+	char *env_man_path = lttng_secure_getenv(DEFAULT_MAN_PATH_ENV);
+
+	if (env_man_path) {
+		return env_man_path;
+	}
+
+	return MANPATH;
+}
+
 LTTNG_HIDDEN
 int utils_show_man_page(int section, const char *page_name)
 {
 	char section_string[8];
 	const char *man_bin_path = get_man_bin_path();
+	const char *man_path = get_man_path();
+	char *cat_file;
 	int ret;
 
 	/* Section integer -> section string */
 	ret = sprintf(section_string, "%d", section);
 	assert(ret > 0 && ret < 8);
 
-	/*
-	 * Execute man pager.
-	 *
-	 * We provide -M to man here because LTTng-tools can
-	 * be installed outside /usr, in which case its man pages are
-	 * not located in the default /usr/share/man directory.
-	 */
-	ret = execlp(man_bin_path, "man", "-M", MANPATH,
-		section_string, page_name, NULL);
+	cat_file = malloc(strlen(man_path) + strlen(page_name) + 10);
+	if (cat_file != NULL) {
+		sprintf(cat_file, "%s/cat%d/%s.%d.gz",
+			man_path, section, page_name, section);
+		DBG("Calling %s %s", man_bin_path, cat_file);
+		ret = execlp(man_bin_path, "zcat", cat_file, NULL);
+		if (ret) {
+			WARN("Calling %s %s failed, try to set LTTNG_MAN_PATH",
+			     man_bin_path, cat_file);
+		}
+		free(cat_file);
+	}
+	else {
+		PERROR("malloc cat_file");
+		ret = ENOMEM;
+	}
 	return ret;
 }
-- 
2.10.0

